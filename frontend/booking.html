<!DOCTYPE html>
<html>
<head>
    <title>Room Booking</title>
</head>
<body>
<h1>Book a Room</h1>

<div>
    <label>Capacity:</label>
    <input type="number" id="capacityFilter" placeholder="e.g. 2" />
    <label>View:</label>
    <input type="text" id="viewFilter" placeholder="sea/mountain/city..." />
    <label>Hotel rating (min):</label>
    <input type="number" id="ratingFilter" placeholder="1 to 5" />
    <button onclick="searchRooms()">Search</button>
</div>

<div id="roomList"></div>

<div>
    <h3>Create Booking:</h3>
    <label>Room ID:</label>
    <input type="number" id="roomIdInput" />
    <br />
    <label>Start Date:</label>
    <input type="date" id="startDate" />
    <br />
    <label>End Date:</label>
    <input type="date" id="endDate" />
    <br />
    <button onclick="bookRoom()">Book</button>
</div>

<script>
    let roomsData = [];
    let hotelsData = [];

    async function searchRooms() {
        const capacityVal = parseInt(document.getElementById('capacityFilter').value) || 0;
        const viewVal = document.getElementById('viewFilter').value.toLowerCase().trim();
        const ratingVal = parseInt(document.getElementById('ratingFilter').value) || 0;

        try {
            const roomsRes = await fetch('http://localhost:8080/api/room');
            roomsData = await roomsRes.json();

            const hotelsRes = await fetch('http://localhost:8080/api/hotel'); // ⬆️ fixed path
            hotelsData = await hotelsRes.json();

            if (!Array.isArray(hotelsData)) throw new Error("Hotel data format error");

            roomsData.forEach(r => {
                const hotel = hotelsData.find(h => h.hotelId === r.hotelId);
                if (hotel) {
                    r.hotelName = hotel.name;
                    r.hotelAddress = hotel.address;
                    r.hotelRating = hotel.rating;
                }
            });

            const filtered = roomsData.filter(r => {
                const meetsCapacity = (r.capacity >= capacityVal);
                const meetsView = (viewVal === '' || (r.view && r.view.toLowerCase().includes(viewVal)));
                const meetsRating = (r.hotelRating >= ratingVal);
                return meetsCapacity && meetsView && meetsRating;
            });

            displayRooms(filtered);
        } catch (err) {
            alert("Error fetching data: " + err.message);
        }
    }

    function displayRooms(list) {
        const container = document.getElementById('roomList');
        container.innerHTML = '';

        if (!list.length) {
            container.innerHTML = '<p>No rooms found.</p>';
            return;
        }

        list.forEach(r => {
            const div = document.createElement('div');
            div.innerHTML = `
                <p>
                    <strong>Room #${r.roomId}</strong><br/>
                    Hotel: ${r.hotelName} (${r.hotelRating} star) - ${r.hotelAddress}<br/>
                    Capacity: ${r.capacity}, View: ${r.view}, Price: $${r.price}
                </p>
            `;
            container.appendChild(div);
        });
    }

    async function bookRoom() {
        const customerId = sessionStorage.getItem('customerID'); // ⬆️ fixed casing
        if (!customerId) {
            alert('You must be logged in as a customer to book');
            return;
        }

        const roomId = parseInt(document.getElementById('roomIdInput').value);
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!roomId || !startDate || !endDate) {
            alert('Please fill in all booking fields');
            return;
        }

        const body = {
            customerId: parseInt(customerId),
            roomId: roomId,
            startDate: startDate,
            endDate: endDate
        };

        try {
            const res = await fetch('http://localhost:8080/api/booking', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if (res.ok) {
                const booking = await res.json();
                alert('Booking created! ID: ' + booking.bookingId);
            } else {
                const msg = await res.text();
                alert('Booking failed: ' + msg);
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }
</script>
</body>
</html>